import dotenv from 'dotenv';
import mongoose from 'mongoose';
import Appointment from '../models/Appointment.js';

dotenv.config();

async function renameDoctorAndPatientFields() {
  try {
    await mongoose.connect(process.env.MONGODB_URI);
    console.log('‚úÖ Conectado ao MongoDB');

    // Encontra agendamentos com doctorId OU patientId
    const appointments = await Appointment.find({
      $or: [
        { doctorId: { $exists: true } },
        { patientId: { $exists: true } }
      ]
    });

    console.log(`üîç Encontrados ${appointments.length} agendamentos para atualizar.`);

    let atualizados = 0;

    for (const [i, appt] of appointments.entries()) {
      const update = {};
      let needsUpdate = false;

      // Verifica e prepara renomea√ß√£o de doctorId ‚Üí doctor
      if (appt.doctorId) {
        update.doctor = appt.doctorId;
        update.$unset = { doctorId: "" };
        needsUpdate = true;
      }

      // Verifica e prepara renomea√ß√£o de patientId ‚Üí patient
      if (appt.patientId) {
        update.patient = appt.patientId;
        update.$unset = { ...update.$unset, patientId: "" };
        needsUpdate = true;
      }

      if (needsUpdate) {
        await Appointment.updateOne(
          { _id: appt._id },
          update
        );
        console.log(`üîÑ ${i + 1}: ${appt._id} atualizado`);
        atualizados++;
      }
    }

    console.log(`\nüéâ Migra√ß√£o conclu√≠da. Total atualizados: ${atualizados}`);
    process.exit(0);
  } catch (err) {
    console.error('‚ùå Erro durante migra√ß√£o:', err);
    process.exit(1);
  }
}

renameDoctorAndPatientFields().catch(console.error);